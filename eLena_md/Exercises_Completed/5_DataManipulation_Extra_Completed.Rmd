---
output:
  rmdformats::html_clean:
    highlight: kate
---

<style>
  code {
    white-space : pre-wrap !important;
    word-break: break-word;
  }
</style>

```{r setup, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

# Data manipulation - independent exercises

In this section we have some extra exercises for the first day of the R course, for those who are interested to test their R skills a little more. Here we explore data from [Finnish Biodiversity Information Facility (FinBIF)](https://laji.fi/en/about/2986) as an example of using data from open data application programming interfaces (APIs).

We will use an R package `finbif` that is an R interface to the FinBIF API. This means we can use the R package to download data from FinBIF directly to R and then continue working with it. You can find more information on the package here: <https://luomus.github.io/finbif/>

**Begin by installing** the package `finbif` (which is not included in the default package selection of our R environment) and loading the necessary libraries in RStudio. Remember to start a new R script (these should be the first commands on the script).

``` r
# install the package ´finbif´
install.packages("finbif")

# load the packages ´finbif´ and ´tidyverse´
library(finbif)
library(tidyverse)
```

Next, we have to get an access token to access the FinBIF data. Replace your\@email.com with your email address. You will then receive the token by email.

``` r
finbif_request_token("your@email.com")
```

Copy the token and active it in R (technically speaking we are setting an environmental variable called FINBIF_ACCESS_TOKEN and giving the token as the value). Replace the long string in quotation marks with the token you received by email.

``` r
Sys.setenv(FINBIF_ACCESS_TOKEN = "xtmSOIxjPwq0pOMB1WvcZgFLU9QBklauOlonWl8K5oaLIx8RniJLrvcJU4v9H7Et")

# Note: this is not a real token and should be replaced with your own one
```

#### **1. Getting the data**

Now we are ready to retrieve data. Let's retrieve the latest 5000 observations of the barn swallow (*Hirundo rustica*, haarapääsky) from FinBIF with the R package `finbif`.

**1.1** Add the following command to your R script and run it as it is. To see what the options in the command `finbif_occurrence` mean and what other options are available to control data retrieval, you can check the [manual the `finbif` package on CRAN](https://cloud.r-project.org/web/packages/finbif/finbif.pdf) (the central repository for R packages).

``` r
swallows_data <- finbif_occurrence("Hirundo rustica", n=5000, select = c("default_vars", "bio_province"))
```

**1.2** Before getting started on the exercises for data manipulation, let's make a copy of the  data to keep original data intact, Then, we will simplify the formatting of dates and remove double entries for regions (´bio_province´). We will also remove observations with dates in winter because we don't expect swallows to occur then. Copy-paste these lines to your R script and run them as they are.

``` r
# making a copy of the data
swallows <- swallows_data

# setting format of the column ´date_time´ to year-month-day
swallows$date_time = as.Date(format(swallows$date_time, "%Y-%m-%d"))

# removing observations in 2023 and before March 2022
swallows <- swallows %>% filter(date_time < "2023-01-01" & date_time > "2022-03-01")

# removing double entries in the column ´bio_province´ by replacing text with the function gsub
swallowplot$bio_province <- gsub(",.*", "", swallowplot$bio_province)
```

Now we are ready for some exercises!


#### **2. Exercises**

**2.1** Look at the first lines of the data and check the structure of the object. 

``` r
head(swallows)
str(swallows)
```

**2.1** The column `bio_province` shows the region of the observation. Let's calculate the number of swallows observations by region.

``` r
by_region <- swallows %>% 
  group_by(bio_province) %>% 
  summarise(count = n())
  
# or

by_region <- swallows %>% 
  count(bio_province)

```

Check the resulting data frame `by_region`. At the bottom there is a region called NA. If you look at the column ´bio_province´ in ´swallows´ carefully, you will notice that some observations are missing the information on region. 

**2.2** Let's fix the problem by modifying the code from the previous step. Remove observations that have NA in the column ´bio_province´.

``` r
by_region <- swallows %>% 
  filter(!is.na(bio_province)) %>% 
  count(bio_province)
  
# or (although prefer the above because removes NAs before any further operations):
  
by_region <- swallows %>% 
  count(bio_province, na.rm = TRUE)
```

**2.4** Use `by_region` to check which region had the most observations of barn swallows and print the top 5.

``` r
by_region %>%
  arrange(desc(count)) %>%
  head(5)
```

#### **3. Saving and exporting your script**

You won't need to save the data, but it's a good idea to save the R script as we will run through the answers tomorrow. Can you remember how to save and export it? You can find some instructions in the **Starting with Data exercise sheet** (steps 7.3 and 7.4).
